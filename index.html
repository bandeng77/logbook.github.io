<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buku Tamu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #7FFFD4;
      display: flex;
      justify-content: center;
    }

    .container {
      display: flex;
      flex-direction: row;
      gap: 40px;
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      max-width: 1000px;
      width: 100%;
    }

    .form-wrapper, .camera-wrapper {
      flex: 1;
      max-width: 500px;
    }

    .camera-wrapper {
      text-align: center;
    }

    img.logo {
      display: block;
      margin: 0 auto 20px;
      max-width: 180px;
    }

    h2 {
      text-align: center;
      margin-top: 0;
      font-size: 26px;
    }

    input, textarea, select, button {
      width: 100%;
      padding: 14px;
      margin-bottom: 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      cursor: pointer;
      background-color: #f2f2f2;
      border: 1px solid #aaa;
      transition: background 0.2s ease;
    }

    button:hover {
      background-color: #ddd;
    }

    video {
      width: 100%;
      max-width: 100%;
      border-radius: 8px;
      margin: 10px auto;
      display: block;
      transform: scaleX(-1); /* Mirror camera view */
    }

    #preview {
      width: 100%;
      max-width: 100%;
      border-radius: 8px;
      margin: 10px auto;
      display: none;
      object-fit: cover;
    }

    canvas {
      display: none;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }

      img.logo {
        max-width: 150px;
      }

      h2 {
        font-size: 22px;
      }

      input, textarea, select, button {
        font-size: 14px;
        padding: 12px;
      }

      video, #preview {
        max-height: 240px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="form-wrapper">
      <img src="genetek-logo.png" alt="Genetek Logo" class="logo" />
      <h2>ðŸ“˜ Buku Tamu</h2>
      <form id="logForm">
        <input type="text" id="tanggal" required readonly style="pointer-events: none; background-color: #f5f5f5;" />
        <input type="text" id="nama" placeholder="Nama" required />
        <input type="text" id="perusahaan" placeholder="Nama Perusahaan" required />
        <input type="text" id="alamat" placeholder="Alamat Perusahaan" required />
        <input type="tel" id="telepon" placeholder="No Telepon" required />
        <select id="tujuan" required>
          <option value="" disabled selected>Pilih Tujuan Kunjungan</option>
          <option value="Antar Dokumen">Antar Dokumen</option>
          <option value="Ambil Dokumen">Ambil Dokumen</option>
          <option value="Antar Barang">Antar Barang</option>
          <option value="Ambil Barang">Ambil Barang</option>
          <option value="Antar Dokumen dan Barang">Antar Dokumen dan Barang</option>
          <option value="Kunjungan">Kunjungan</option>
        </select>
        <input type="text" id="deskripsi" placeholder="Deskripsi Kunjungan" required />
        <button type="submit">+ Tambah ke Buku Tamu</button>
      </form>
    </div>

    <div class="camera-wrapper">
      <video id="video" autoplay></video>
      <button type="button" onclick="takePhoto()">ðŸ“¸ Ambil Foto</button>
      <canvas id="canvas"></canvas>
      <img id="preview" alt="Preview Foto" />
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <!-- Firebase Storage SDK tidak diperlukan lagi jika menyimpan Base64 di Firestore -->

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC8LlcI_ccRGieFNjlVFLfEr2c4PBg6J70", // Ganti dengan API Key Anda
      authDomain: "logbook-e6ab3.firebaseapp.com", // Ganti dengan Auth Domain Anda
      projectId: "logbook-e6ab3", // Ganti dengan Project ID Anda
      storageBucket: "logbook-e6ab3.appspot.com", // Ganti dengan Storage Bucket Anda
      messagingSenderId: "484546392348", // Ganti dengan Messaging Sender ID Anda
      appId: "1:484546392348:web:861616b680427c158ecad9" // Ganti dengan App ID Anda
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // const storage = firebase.storage(); // Tidak diperlukan lagi
    // const storageRef = storage.ref(); // Tidak diperlukan lagi

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const preview = document.getElementById('preview');
    let photoData = ''; // Akan menyimpan Base64 string dari foto

    // Fungsi untuk memperbarui tanggal dan waktu secara real-time
    function updateDateTimeRealtime() {
      setInterval(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        const formattedTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        document.getElementById('tanggal').value = formattedTime;
      }, 1000);
    }

    // Panggil fungsi updateDateTimeRealtime saat halaman dimuat
    window.onload = () => {
      updateDateTimeRealtime();
    };

    // Meminta akses kamera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error('Akses kamera ditolak:', err));

    // Fungsi untuk mengambil foto dari kamera
    function takePhoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      context.save();
      context.scale(-1, 1); // Mirror the image horizontally
      context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      context.restore();

      // Ambil data gambar sebagai Base64 string (kualitas 30%)
      // Kualitas rendah sangat disarankan untuk mengurangi ukuran data
      photoData = canvas.toDataURL('image/jpeg', 0.3);
      preview.src = photoData;
      preview.style.display = 'block';
    }

    // Fungsi helper b64toBlob tidak diperlukan lagi jika menyimpan Base64 langsung

    // Handler saat formulir disubmit
    document.getElementById('logForm').onsubmit = function(e) {
      e.preventDefault();

      if (!photoData) {
        alert("Silakan ambil foto terlebih dahulu sebelum submit.");
        return;
      }

      const tanggal = document.getElementById('tanggal').value;
      const nama = document.getElementById('nama').value;
      const perusahaan = document.getElementById('perusahaan').value;
      const alamat = document.getElementById('alamat').value;
      const telepon = document.getElementById('telepon').value;
      const tujuan = document.getElementById('tujuan').value;
      const deskripsi = document.getElementById('deskripsi').value; // Ambil nilai deskripsi

      // Data yang akan disimpan di Firestore, termasuk foto Base64
      const dataToFirestore = {
        tanggal,
        nama,
        perusahaan,
        alamat,
        telepon,
        tujuan,
        deskripsi, // Sertakan deskripsi
        foto: photoData // Simpan data Base64 langsung
      };

      db.collection("logbook").add(dataToFirestore)
        .then(() => {
          alert("Data berhasil disimpan di Firestore");
          // Reset formulir dan tampilan setelah berhasil
          document.getElementById('logForm').reset();
          photoData = ''; // Kosongkan data foto
          preview.src = ''; // Kosongkan preview
          preview.style.display = 'none'; // Sembunyikan preview
        })
        .catch(err => {
          console.error("Gagal menyimpan data:", err);
          alert("Gagal menyimpan data: " + err.message);
        });
    };
  </script>
</body>
</html>
